# è¾°åºï¼ˆChronosï¼‰å¼€å‘è€…æ–‡æ¡£

## é¡¹ç›®ä¿¡æ¯

- **åŒ…å**: `com.chronos.calendar`
- **åº”ç”¨ID**: `com.chronos.calendar`
- **æœ€å°SDK**: 24 (Android 7.0)
- **ç›®æ ‡SDK**: 36 (Android 14)
- **ç¼–è¯‘SDK**: 36

## æ„å»ºé…ç½®

### Gradleé…ç½®æ–‡ä»¶

#### `build.gradle.kts` (app)
```kotlin
plugins {
    alias(libs.plugins.android.application)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.kotlin.kapt)  // Rooméœ€è¦
}

android {
    namespace = "com.chronos.calendar"
    compileSdk = 36
    
    buildFeatures {
        viewBinding = true  // å¯ç”¨ViewBinding
    }
}
```

### ä¸»è¦ä¾èµ–

| åº“ | ç”¨é€” |
|---|---|
| Room | æœ¬åœ°æ•°æ®åº“ |
| Lifecycle (ViewModel, LiveData) | MVVMæ¶æ„ |
| Coroutines | å¼‚æ­¥ç¼–ç¨‹ |
| WorkManager | åå°ä»»åŠ¡ |
| ViewPager2 | é¡µé¢æ»‘åŠ¨ |
| Material Design 3 | UIç»„ä»¶ |

## æ ¸å¿ƒç»„ä»¶è¯´æ˜

### 1. æ•°æ®æ¨¡å‹ (data/)

#### Event.kt - äº‹ä»¶å®ä½“
```kotlin
@Entity(tableName = "events")
data class Event(
    @PrimaryKey(autoGenerate = true) val id: Long,
    val title: String,
    val startTime: Long,
    val endTime: Long,
    val reminderMinutes: Int,
    // ... å…¶ä»–å­—æ®µ
)
```

**å…³é”®æ‰©å±•å‡½æ•°**:
- `isOnDate(Calendar)` - åˆ¤æ–­äº‹ä»¶æ˜¯å¦åœ¨æŒ‡å®šæ—¥æœŸ
- `isInDateRange(start, end)` - åˆ¤æ–­äº‹ä»¶æ˜¯å¦åœ¨æ—¶é—´èŒƒå›´å†…
- `getDurationMinutes()` - è·å–äº‹ä»¶æ—¶é•¿

#### EventDao.kt - æ•°æ®è®¿é—®
```kotlin
@Dao
interface EventDao {
    @Query("SELECT * FROM events ORDER BY startTime ASC")
    fun getAllEvents(): LiveData<List<Event>>
    
    @Query("SELECT * FROM events WHERE startTime >= :startTime AND endTime <= :endTime")
    fun getEventsInRange(startTime: Long, endTime: Long): LiveData<List<Event>>
    
    @Insert
    suspend fun insert(event: Event): Long
    
    @Update
    suspend fun update(event: Event)
    
    @Delete
    suspend fun delete(event: Event)
}
```

#### EventRepository.kt - æ•°æ®ä»“åº“
å°è£…æ•°æ®è®¿é—®é€»è¾‘ï¼Œæä¾›ç®€æ´çš„APIç»™ViewModelä½¿ç”¨ã€‚

### 2. è§†å›¾æ¨¡å‹ (viewmodel/)

#### EventViewModel.kt
```kotlin
class EventViewModel(application: Application) : AndroidViewModel(application) {
    private val repository: EventRepository
    val allEvents: LiveData<List<Event>>
    
    fun insert(event: Event, onComplete: ((Long) -> Unit)?)
    fun update(event: Event, onComplete: (() -> Unit)?)
    fun delete(event: Event, onComplete: (() -> Unit)?)
    suspend fun getEventById(eventId: Long): Event?
}
```

**ä½¿ç”¨æ–¹å¼**:
```kotlin
// åœ¨Activity/Fragmentä¸­
private val viewModel: EventViewModel by viewModels()

// è§‚å¯Ÿæ•°æ®å˜åŒ–
viewModel.allEvents.observe(this) { events ->
    // æ›´æ–°UI
}

// æ·»åŠ äº‹ä»¶
viewModel.insert(event) { eventId ->
    // å®Œæˆå›è°ƒ
}
```

### 3. UIç»„ä»¶ (ui/)

#### MainActivity.kt
ä¸»Activityï¼Œç®¡ç†ViewPager2å’Œè§†å›¾åˆ‡æ¢ã€‚

**å…³é”®åŠŸèƒ½**:
- ViewPager2é…ç½®å’Œé€‚é…å™¨è®¾ç½®
- TabLayoutä¸ViewPager2è”åŠ¨
- FABæŒ‰é’®ç‚¹å‡»å¤„ç†
- èœå•é¡¹å¤„ç†ï¼ˆè§†å›¾åˆ‡æ¢ã€è¿”å›ä»Šå¤©ï¼‰

#### CalendarViewPagerAdapter.kt
```kotlin
class CalendarViewPagerAdapter(
    fragmentActivity: FragmentActivity,
    private val viewMode: CalendarViewMode
) : FragmentStateAdapter(fragmentActivity) {
    
    companion object {
        const val START_POSITION = 1000  // ä¸­é—´èµ·å§‹ä½ç½®
        private const val TOTAL_PAGES = 2000  // æ€»é¡µæ•°
    }
    
    override fun createFragment(position: Int): Fragment {
        val offset = position - START_POSITION
        return when (viewMode) {
            CalendarViewMode.MONTH -> MonthViewFragment.newInstance(offset)
            CalendarViewMode.WEEK -> WeekViewFragment.newInstance(offset)
            CalendarViewMode.DAY -> DayViewFragment.newInstance(offset)
        }
    }
}
```

#### MonthViewFragment.kt
æœˆè§†å›¾Fragmentï¼Œä½¿ç”¨RecyclerView + GridLayoutManageræ˜¾ç¤ºæ—¥å†ç½‘æ ¼ã€‚

#### MonthCalendarAdapter.kt
æœˆå†é€‚é…å™¨ï¼Œç®¡ç†42ä¸ªæ—¥æœŸå•å…ƒæ ¼ï¼ˆ6è¡ŒÃ—7åˆ—ï¼‰ã€‚

**æ—¥æœŸè®¡ç®—é€»è¾‘**:
```kotlin
fun setMonth(calendar: Calendar) {
    // 1. è®¡ç®—æœ¬æœˆ1å·æ˜¯æ˜ŸæœŸå‡ 
    val firstDayOfWeek = monthCalendar.get(Calendar.DAY_OF_WEEK) - 1
    
    // 2. æ·»åŠ ä¸Šæœˆæœ«å°¾å‡ å¤©
    for (i in firstDayOfWeek - 1 downTo 0) { ... }
    
    // 3. æ·»åŠ æœ¬æœˆæ‰€æœ‰æ—¥æœŸ
    for (day in 1..daysInMonth) { ... }
    
    // 4. æ·»åŠ ä¸‹æœˆå¼€å¤´å‡ å¤©ï¼Œè¡¥è¶³6è¡Œ
    val remainingDays = 42 - days.size
    for (day in 1..remainingDays) { ... }
}
```

#### EventBottomSheetFragment.kt
åº•éƒ¨å¼¹çª—ï¼Œå¤„ç†äº‹ä»¶çš„æ·»åŠ å’Œç¼–è¾‘ã€‚

**å…³é”®åŠŸèƒ½**:
- DatePickerDialog / TimePickerDialog
- æ•°æ®éªŒè¯ï¼ˆæ ‡é¢˜å¿…å¡«ã€æ—¶é—´æœ‰æ•ˆæ€§ï¼‰
- åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†

### 4. é€šçŸ¥æé†’ (notification/)

#### EventReminderWorker.kt
```kotlin
class EventReminderWorker(
    context: Context,
    params: WorkerParameters
) : CoroutineWorker(context, params) {
    
    override suspend fun doWork(): Result {
        // 1. è·å–éœ€è¦æé†’çš„äº‹ä»¶
        val upcomingEvents = repository.getUpcomingEventsWithReminders()
        
        // 2. æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æé†’æ—¶é—´
        upcomingEvents.forEach { event ->
            val reminderTime = calculateReminderTime(event)
            if (isTimeToRemind(reminderTime)) {
                sendNotification(event)
            }
        }
        
        return Result.success()
    }
}
```

#### ReminderScheduler.kt
```kotlin
object ReminderScheduler {
    fun scheduleReminderCheck(context: Context) {
        val workRequest = PeriodicWorkRequestBuilder<EventReminderWorker>(
            15, TimeUnit.MINUTES  // æ¯15åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        ).build()
        
        WorkManager.getInstance(context).enqueueUniquePeriodicWork(
            WORK_NAME,
            ExistingPeriodicWorkPolicy.KEEP,
            workRequest
        )
    }
}
```

## æ•°æ®æµç¨‹

### æ·»åŠ äº‹ä»¶æµç¨‹
```
ç”¨æˆ·è¾“å…¥ â†’ EventBottomSheetFragment 
         â†’ EventViewModel.insert()
         â†’ EventRepository.insert()
         â†’ EventDao.insert()
         â†’ Room Database
         â†’ LiveDataæ›´æ–°
         â†’ UIè‡ªåŠ¨åˆ·æ–°
```

### æŸ¥è¯¢äº‹ä»¶æµç¨‹
```
Fragmentå¯åŠ¨ â†’ è§‚å¯ŸViewModelçš„LiveData
           â†’ Repositoryè¿”å›LiveData<List<Event>>
           â†’ Roomè‡ªåŠ¨æŸ¥è¯¢
           â†’ æ•°æ®å˜åŒ–æ—¶LiveDataå›è°ƒ
           â†’ Adapteræ›´æ–°
           â†’ RecyclerViewåˆ·æ–°
```

### æé†’æµç¨‹
```
Appå¯åŠ¨ â†’ ChronosApplication.onCreate()
       â†’ ReminderScheduler.scheduleReminderCheck()
       â†’ WorkManagerå®šæœŸæ‰§è¡ŒEventReminderWorker
       â†’ æ£€æŸ¥å¾…æé†’äº‹ä»¶
       â†’ å‘é€ç³»ç»Ÿé€šçŸ¥
```

## å…³é”®ä»£ç ç‰‡æ®µ

### ViewBindingä½¿ç”¨
```kotlin
class MainActivity : AppCompatActivity() {
    private lateinit var binding: ActivityMainBinding
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)
        
        // ç›´æ¥ä½¿ç”¨bindingè®¿é—®è§†å›¾
        binding.fab.setOnClickListener { ... }
    }
}
```

### Coroutinesä½¿ç”¨
```kotlin
// åœ¨ViewModelä¸­
fun insert(event: Event, onComplete: ((Long) -> Unit)? = null) {
    viewModelScope.launch {
        val id = repository.insert(event)  // suspendå‡½æ•°
        onComplete?.invoke(id)
    }
}

// åœ¨Fragmentä¸­
lifecycleScope.launch {
    val event = viewModel.getEventById(eventId)
    // æ›´æ–°UI
}
```

### LiveDataè§‚å¯Ÿ
```kotlin
viewModel.selectedDate.observe(viewLifecycleOwner) { date ->
    updateUI(date)
}
```

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹æ•°æ®åº“
ä½¿ç”¨Android Studioçš„Database Inspectorï¼š
```
View -> Tool Windows -> App Inspection -> Database Inspector
```

### 2. æ—¥å¿—è¾“å‡º
```kotlin
Log.d("MainActivity", "æŒ‰é’®è¢«ç‚¹å‡»äº†")
Log.d("EventReminderWorker", "å‘é€é€šçŸ¥: ${event.title}")
```

### 3. WorkManagerè°ƒè¯•
```kotlin
// æŸ¥çœ‹WorkçŠ¶æ€
val workInfos = WorkManager.getInstance(context)
    .getWorkInfosForUniqueWork("event_reminder_check")
    .get()
```

## å¸¸è§é—®é¢˜è§£å†³

### Q1: Roomç¼–è¯‘é”™è¯¯
**A**: ç¡®ä¿åœ¨`build.gradle.kts`ä¸­æ·»åŠ äº†kaptæ’ä»¶ï¼š
```kotlin
plugins {
    alias(libs.plugins.kotlin.kapt)
}
```

### Q2: ViewBindingæœªç”Ÿæˆ
**A**: æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†ViewBindingï¼š
```kotlin
android {
    buildFeatures {
        viewBinding = true
    }
}
```

### Q3: WorkManagerä¸å·¥ä½œ
**A**: 
1. æ£€æŸ¥æ˜¯å¦åœ¨Applicationçš„onCreateä¸­è°ƒåº¦
2. ç¡®è®¤ç³»ç»Ÿæœªé™åˆ¶åå°è¿è¡Œ
3. ä½¿ç”¨ä¸€æ¬¡æ€§Workeræµ‹è¯•

## æ‰©å±•å¼€å‘å»ºè®®

### æ·»åŠ é‡å¤æ—¥ç¨‹
1. åœ¨Eventä¸­ä½¿ç”¨recurrenceRuleå­—æ®µ
2. åˆ›å»ºRecurrenceRuleè§£æå™¨
3. åœ¨æŸ¥è¯¢æ—¶å±•å¼€é‡å¤æ—¥ç¨‹
4. UIæ·»åŠ é‡å¤é€‰é¡¹

### æ·»åŠ å¤šæ—¥å†
1. åˆ›å»ºCalendarå®ä½“
2. Eventæ·»åŠ calendarIdå¤–é”®
3. UIæ·»åŠ æ—¥å†é€‰æ‹©å™¨
4. æ”¯æŒæ—¥å†é¢œè‰²

### æ•°æ®å¯¼å…¥å¯¼å‡º
1. å®ç°iCalendaræ ¼å¼è§£æ
2. åˆ›å»ºICSæ–‡ä»¶ç”Ÿæˆå™¨
3. æ·»åŠ åˆ†äº«åŠŸèƒ½

## ä»£ç é£æ ¼

- ä½¿ç”¨Kotlinæƒ¯ç”¨è¯­æ³•
- éµå¾ªMaterial DesignæŒ‡å—
- æ³¨é‡Šå…³é”®ä¸šåŠ¡é€»è¾‘
- å‡½æ•°å•ä¸€èŒè´£
- åˆç†ä½¿ç”¨æ‰©å±•å‡½æ•°

## æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•
- Repositoryæµ‹è¯•
- ViewModelæµ‹è¯•
- æ—¥æœŸè®¡ç®—é€»è¾‘æµ‹è¯•

### UIæµ‹è¯•
- Espressoæµ‹è¯•å…³é”®æµç¨‹
- æµ‹è¯•æ—¥ç¨‹æ·»åŠ /ç¼–è¾‘/åˆ é™¤

---

**Happy Coding!** ğŸš€

